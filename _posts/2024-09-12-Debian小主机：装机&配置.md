---
layout: post
title: Debian小主机：装机&配置
categories: jekyll/update
tags: [Linux, Debian, 装机, ssh]
---

开学以来就开始在手机上折腾termux，想挂一些脚本或者建个网站之类的，但是受限于安卓系统，有些功能是缺失的，而且旧手机的性能和扩展性都很差。最后下决心买了一个x86的小主机，N100处理器。

### 旧手机上termux

最开始在旧手机上弄termux。
termux是一个安卓上的一个模拟终端，提供命令行的界面和操作方式，使用pkg作为包管理器。它的生态还是相当丰富的，Python，JavaScript，Java，C++的环境都可以搭建，也有Git，MariaDB，OpenSSH等实用工具。在这里，我配置了ssh服务器，用笔记本和安卓平板远程连接输入命令；我安装了花生壳的内网穿透，把https端口映射到公网；我搭建了一个基于QQ开放平台接口的QQ机器人，并把它接入vivo蓝心大模型。总的来说，可玩性还是很足的，但是有些Linux项目还是会因为缺少依赖而无法在termux上运行，考虑到兼容性和性能及拓展性，我还是决定买一个完全体的PC主机。

### 购入小主机

##### 装机：安装Debian系统

在B站反复对比配置和考虑硬件兼容性后，决定下单N100的主机。选择的是没有网卡、内存和硬盘的准系统，和客服沟通后表示，可以20元加装网卡（Intel 7260）；内存问了适配型号：3200MHz的笔记本DDR4，咸鱼上三星的8G是67元，而商家这里要87元，于是便决定在咸鱼自己购买；硬盘则是从笔记本上换下来的512G的M2短固态硬盘。主机和配件都到了后，便开始装机，结果插好机器通电后，发现主板指示灯的DDR_LED一直在红灯，也就是内存条不兼容！
![DDR_LED红灯](https://lidingxin-top.oss-cn-beijing.aliyuncs.com/photos/mmexport1726228336135.jpg)
无奈，和咸鱼商家沟通后退货，并以90元从主机商处购买内存条（多出来的3元是运费）。好在这次的内存条一次点亮，没有出现别的差错。关于主机的显示器，平时只需要挂机即可，为此特别买一个显示器有些浪费，便选择了使用采集卡的方案，HDMI线从主机接到采集卡上，然后再经由采集卡的Type-c口输出画面到笔记本上，经由笔记本上的OBS显示画面，一切正常，开始装机！
![采集卡输出画面到笔记本的OBS上](https://lidingxin-top.oss-cn-beijing.aliyuncs.com/photos/IMG_20240910_111108.jpg)
选择安装的系统是Debian，第一次安装的时候，我使用手机热点作为装机时的互联网接入，并且选择了清华的镜像源来加快下载速度，但是就在即将安装成功，我要拔出来U盘的时候，硬盘先弹了起来。我的硬盘是2242的短盘，而这个主机的默认规格是2280的长盘，它虽然留了2242盘的安装空位，但是没有底座螺丝，我也没有兼容的底座螺丝，短盘被我用双面胶和胶棒简陋的固定在硬盘位，这也导致了我一动它就弹起来了，装机失败。
晚上回来后，用舍友的胶水固定了硬盘底座螺丝，重新安装系统。这次使用的笔记本的热点，结果不知什么原因，在选择源的时候，无论官方的源还是国内镜像源，全部都无法使用，最终安装了最小标准系统。安装好后，网卡却一直出问题。校园网采用浏览器登录认证的方式，于是我安装了xfce桌面，Firefox和NetworkManager，每次重启后，就会自动连接上NKU_WLAN，但是过了几十分钟后，网卡驱动模块iwlwifi就开始报错，并且无法接入网络。copilot给出的解决方案和从网上搜到的相关解决方案都没有奏效，它还是这样。
鉴于这种情况，我只好再次利用旧手机：手机接入校园网，并且持续保持连接——这我早在手机上实现了，然后通过USB连接小主机和手机，手机通过USB共享网络。这样，这个小主机的网络总算稳定了。

##### 配置SSH远程连接

- **连接SSH服务**
在小主机上，通过 ```ip a``` 识别本机的网络接口：
![ip a](https://lidingxin-top.oss-cn-beijing.aliyuncs.com/photos/9-14.png)
其中，```lo``` 是本地网络，```enp1s0``` 是以太网口， ```wlp2s0``` 是无线网口， ```enxd6fb2373e8c2```  就是USB网络。```192.168.42.126``` 就是本机在USB网络中的局域网IP，也就是可以在手机通过这个IP地址访问到小主机。
在手机上执行同样的命令，分别安装SSH服务器，启动SSH服务。termux上通过 ```whoami``` 命令可以获取用户名，Debian上的用户名则是在注册时自己输入的。

- **通过SSH密钥配置免密访问**
知道了用户名和IP地址就可以通过ssh连接到主机了，在终端输入：
```ssh {username}@{ip_addr} -p {server_port}``` 连接到远程主机。
但是此时连接后还需要输入用户密码进行认证，如果想免除密码认证，可以提前配置好SSH密钥，Github的拉取和推送操作也用到了SSH密钥。
首先如果访问主机还没有生成SSH密钥的话，通过 
```ssh-keygen -t rsa -b 4096 -C "{your_email_addr}"``` 
然后在接下来生成位置的询问、输入密码的询问、输入密码的重复确认直接点击回车就可以，这样就会在默认位置（通常是用户目录下 ```~/.ssh``` 下），生成没有额外加密的4096位的基于rsa加密算法的私钥 ```id_rsa```和公钥 ```id_rsa.pub```，这个密钥就可以用作标识本机的密钥，然后把公钥内容添加到服务器的 ```~/.ssh/authoried_keys``` 文件里，这样，就可以实现免密访问了。
在 ```~/.ssh/config``` 文件中输入如下格式的数据，可以通过 ```ssh {server_name}``` 快捷访问目标服务器：
```
Host {server_name}
    HostName {server_ip}
    User {user_name}
    Port {server_port}
    IdentityFile ~/.ssh/id_rsa
```

- **SSH密钥的连接过程**
>1. 客户端发起连接：客户端向服务器发起SSH连接请求。
>2. 服务器验证公钥：服务器检查客户端提供的公钥是否在`~/.ssh/authorized_keys`文件中。  
>3. 生成挑战：如果公钥匹配，服务器生成一个随机数（挑战）并使用客户端的公钥加密这个随机数，然后将加密后的挑战发送给客户端。
>4. 客户端解密挑战：客户端使用其私钥解密收到的挑战，得到原始的随机数。
>5. 客户端响应挑战：客户端将解密后的随机数发送回服务器。  
>6. 服务器验证响应：服务器检查客户端返回的随机数是否与原始的随机数匹配。如果匹配，服务器确认客户端的身份，并允许连接

**配置手机为Debian的SSH的跳板服务器**

配置手机的 ```~/.ssh/config``` 为：
```
Host {server_name}
    HostName {server_ip}
    User {user_name}
    Port {server_port}
    IdentityFile ~/.ssh/id_rsa
	ForwardAgent yes
```
在其中添加了 ```ForwardAgent yes``` 表示允许手机进行ssh转发。然后把本机的ssh公钥添加到目标服务器的 ```authorized_keys``` 中配置ssh密钥免密访问，这样就可以直接在本机通过 ```ssh debian``` 远程访问目标服务器了，包括远程使用VS Code。

